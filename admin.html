<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>PÄŒR | SPRÃVA SYSTÃ‰MU</title>
    <style>
        /* Styl pro zastraÅ¡ovacÃ­ zprÃ¡vu */
        .alert-screen {
            background-color: #3d0000;
            color: #ffcccc;
            padding: 40px;
            border: 2px solid red;
            box-shadow: 0 0 50px red;
            display: none; /* DefaultnÄ› skryto */
            text-align: justify;
            font-family: 'Courier New', monospace;
        }
        .alert-screen h1 { color: red; text-transform: uppercase; text-align: center; font-size: 32px; border-bottom: 2px solid red; padding-bottom: 20px; }
        .alert-screen strong { color: white; text-decoration: underline; }
        
        /* Styl pro Admin panel */
        .admin-panel { display: none; } /* DefaultnÄ› skryto */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #0d1117; }
        th, td { border: 1px solid #30363d; padding: 10px; text-align: left; }
        th { background: #1f2937; color: #58a6ff; }
        tr:hover { background: #161b22; }
        .role-badge { background: #0055a4; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px; }
        .action-btn { background: #238636; padding: 5px 10px; font-size: 12px; width: auto; margin: 0; }
    </style>
</head>
<body>

    <div id="accessDenied" class="alert-screen">
        <h1>â›” KRITICKÃ‰ NARUÅ ENÃ BEZPEÄŒNOSTI â›”</h1>
        <p><strong>UPOZORNÄšNÃ:</strong> SystÃ©m detekoval neautorizovanÃ½ pokus o pÅ™Ã­stup do vyhrazenÃ© sekce "TOP SECRET / Å˜ÃZENÃ LIDSKÃCH ZDROJÅ®". VaÅ¡e identita a IP adresa byly zaznamenÃ¡ny a odeslÃ¡ny Odboru vnitÅ™nÃ­ kontroly (OVK).</p>
        <br>
        <p>TÃ­mto jednÃ¡nÃ­m jste se mohl/a dopustit trestnÃ©ho Äinu dle <strong>Â§ 230 TrestnÃ­ho zÃ¡konÃ­ku (40/2009 Sb.)</strong> â€“ <em>NeoprÃ¡vnÄ›nÃ½ pÅ™Ã­stup k poÄÃ­taÄovÃ©mu systÃ©mu a nosiÄi informacÃ­</em>. Dle odstavce 2 hrozÃ­ pachateli odnÄ›tÃ­ svobody aÅ¾ na dvÄ› lÃ©ta, zÃ¡kaz Äinnosti nebo propadnutÃ­ vÄ›ci.</p>
        <br>
        <p>DÃ¡le upozorÅˆujeme na poruÅ¡enÃ­ <strong>ZÃ¡kona Ä. 181/2014 Sb., o kybernetickÃ© bezpeÄnosti</strong>, konkrÃ©tnÄ› Â§ 7, kterÃ½ definuje naruÅ¡enÃ­ dÅ¯vÄ›rnosti, integrity a dostupnosti informacÃ­ v kritickÃ© informaÄnÃ­ infrastruktuÅ™e stÃ¡tu.</p>
        <br>
        <p>VaÅ¡e jednÃ¡nÃ­ je nynÃ­ posuzovÃ¡no jako <em>bezpeÄnostnÃ­ incident typu A+</em>. OkamÅ¾itÄ› opusÅ¥te tuto sekci, vypnÄ›te terminÃ¡l a pÅ™ejdÄ›te na naÅ¡Ã­ aplikaci do pÅ™Ã­sluÅ¡nÃ© mÃ­stnosti, nebo se neprodlenÄ› nahlaste svÃ©mu nadÅ™Ã­zenÃ©mu k podÃ¡nÃ­ vysvÄ›tlenÃ­.</p>
        <br>
        <div style="text-align: center; color: red; font-size: 20px; font-weight: bold; margin-top: 30px;">
            LOGOVÃNÃ TERMINÃLU DOKONÄŒENO...<br>
            ODESÃLÃNÃ HLÃÅ ENÃ NA PREZIDIUM...
        </div>
        <button onclick="window.location.href='spis.html'" style="background: #550000; margin-top: 30px;">OKAMÅ½ITÃ NÃVRAT NA HLAVNÃ STRÃNKU</button>
    </div>

    <div id="adminPanel" class="container admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ğŸ› ï¸ SprÃ¡va pÅ™Ã­sluÅ¡nÃ­kÅ¯ a rolÃ­</h2>
            <button onclick="window.location.href='spis.html'" style="width:auto; background:#30363d;">ZpÄ›t na spisy</button>
        </div>
        <p>Zde mÅ¯Å¾ete spravovat role a pÅ™Ã­stupy. Vyberte uÅ¾ivatele ze seznamu.</p>

        <div id="loading">NaÄÃ­tÃ¡m personÃ¡lnÃ­ databÃ¡zi...</div>
        
        <table id="usersTable" style="display:none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>JmÃ©no</th>
                    <th>Discord ID</th>
                    <th>SouÄasnÃ© Role</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody id="usersBody"></tbody>
        </table>
    </div>

    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100;">
        <div style="background:#161c2d; width:500px; margin:100px auto; padding:20px; border-radius:8px; border: 1px solid #0055a4;">
            <h3>Upravit role: <span id="modalUsername" style="color:#58a6ff;"></span></h3>
            <p style="font-size:12px; color:#888;">Vyberte max. 5 rolÃ­.</p>
            <div id="modalRoles" style="max-height:300px; overflow-y:auto; display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-bottom:20px;"></div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveRoles()" style="background:#238636;">ULOÅ½IT ZMÄšNY</button>
                <button onclick="closeModal()" style="background:#3d1a1a;">ZRUÅ IT</button>
            </div>
        </div>
    </div>

    <script>
        // 1. OKAMÅ½ITÃ KONTROLA HODNOSTI
        const user = JSON.parse(localStorage.getItem('pcr_user'));
        const allowedRanks = ['GenerÃ¡lporuÄÃ­k', 'GenerÃ¡lmajor', 'BrigÃ¡dnÃ­ generÃ¡l'];
        
        // ZjistÃ­me, jestli mÃ¡ user aspoÅˆ jednu z povolenÃ½ch hodnostÃ­
        const hasAccess = user && user.roles && user.roles.some(role => allowedRanks.includes(role));

        if (!hasAccess) {
            document.getElementById('accessDenied').style.display = 'block';
        } else {
            document.getElementById('adminPanel').style.display = 'block';
            loadUsers();
        }

        // --- ADMIN LOGIKA ---

        let allRoles = [];
        let currentEditingId = null;

        async function loadUsers() {
            const res = await fetch('/.netlify/functions/admin-api?action=list');
            const data = await res.json();
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('usersTable').style.display = 'table';
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = '';

            // NaÄtenÃ­ seznamu vÅ¡ech moÅ¾nÃ½ch rolÃ­ (pro modal)
            allRoles = data.allRoles;

            data.users.forEach(u => {
                const roleBadges = u.roles ? u.roles.map(r => `<span class="role-badge">${r}</span>`).join('') : '<span style="color:#666">-</span>';
                tbody.innerHTML += `
                    <tr>
                        <td>${u.id}</td>
                        <td><strong>${u.username}</strong></td>
                        <td>${u.discord_id || '-'}</td>
                        <td>${roleBadges}</td>
                        <td><button class="action-btn" onclick="openEdit(${u.id}, '${u.username}', '${u.roles || ''}')">UPRAVIT</button></td>
                    </tr>
                `;
            });
        }

        function openEdit(id, name, currentRolesStr) {
            currentEditingId = id;
            document.getElementById('modalUsername').innerText = name;
            document.getElementById('editModal').style.display = 'block';
            
            const currentRoles = currentRolesStr.split(',');
            const container = document.getElementById('modalRoles');
            container.innerHTML = '';

            allRoles.forEach(r => {
                const isChecked = currentRoles.includes(r.role_name) ? 'checked' : '';
                container.innerHTML += `<label style="font-size:13px; display:flex; align-items:center;"><input type="checkbox" value="${r.id}" ${isChecked}> ${r.role_name}</label>`;
            });
        }

        async function saveRoles() {
            const checkboxes = document.querySelectorAll('#modalRoles input:checked');
            if (checkboxes.length > 5) {
                alert("â›” MaximÃ¡lnÄ› 5 rolÃ­ na osobu!");
                return;
            }
            
            const roleIds = Array.from(checkboxes).map(c => c.value);
            
            const btn = document.querySelector('#editModal button');
            btn.innerText = "UKLÃDÃM...";

            await fetch('/.netlify/functions/admin-api', {
                method: 'POST',
                body: JSON.stringify({ action: 'update', userId: currentEditingId, roleIds: roleIds })
            });

            closeModal();
            loadUsers(); // Refresh tabulky
            btn.innerText = "ULOÅ½IT ZMÄšNY";
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
    </script>
</body>
</html>
